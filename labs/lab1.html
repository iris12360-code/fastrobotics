<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MAE 4190 â€“ Lab 1</title>

  <style>
    body {
      font-family: Arial, sans-serif;
    }

    .content {
      max-width: 800px;
      margin: 60px auto;
      padding: 0 20px;
    }

    h1 { font-size: 2.2em; }
    h2 { font-size: 1.6em; margin-top: 40px; }
    h3 { font-size: 1.3em; margin-top: 20px; }
    p  { line-height: 1.6; }

    img {
      display: block;
      margin: 20px auto;
      max-width: 100%;
    }

    .code-block {
  margin: 30px 0;
}

.code-header {
  background-color: #eaeaea;
  padding: 6px 12px;
  font-size: 0.9em;
  font-family: monospace;
  border-radius: 6px 6px 0 0;
}

.code-header span {
  font-weight: bold;
}

.code-block pre {
  margin: 0;
  background-color: #f5f5f5;
  padding: 16px;
  overflow-x: auto;
  border-radius: 0 0 6px 6px;
}

code {
  font-family: Consolas, Monaco, monospace;
  font-size: 0.95em;
}

  </style>
</head>

<body>
    <div class="content">

    <h1>Lab 1: Artemis + Bluetooth </h1>

    <h2>Lab 1a</h2>
    <p>In lab 1a, I got to review Arduino and conducted some fucntions on Redboard Artemis Nano, 
        such as temperature measurement, microphone. Baud rate measures communication speed, 
    basically determining how fast the measurement can be reflected on the channel. </p>

    <h3>Blink</h3>
    <a href="https://youtube.com/shorts/95jPUAr5tGk?si=416UKx78ig4Bty50" target="_blank">
  Watch the video
</a>
    <h3>Serial</h3>
    <img src="../images/lab1/serial.png" alt="serial failed" width="550">
    <p>Serial communication requires consistent baud rate ebtween transmitter and receiver to 
    ensure its accuracy. As picture below shown, it failed once I change baud rate to an
    inconsistent value of 38400 baud. </p>
    <img src="../images/lab1/Serial_fail.png" alt="serial failed" width="550">
    <h3>AnalogRead</h3>
    <p>Comparing the following two images: the first one is when I held the board and blew
        hot air to it; the second one is when leaving it back in the air. Temperature is higher 
        in the first image. 
    </p>
    <img src="../images/lab1/tem_higher.png" alt="temperature when holding" width="550">
    <img src="../images/lab1/tem_lower.png" alt="temperature when leaving in the air" width="550">
    <h3>MicrophoneOutput</h3>
    <img src="../images/lab1/microphone.png" alt="microphone changes value" width="550">
    <p>Holding the board close to table and knocking on the table, loudest frequency increases
        from maximum value of 1762 to 8228. 
    </p>

    <h2>Lab 1b</h2>
    <p>In lab 1b, I implemented and tested a couple customed BLE commands to achieve data
        exchange using GATT characterisitics.  
         </p>
    <h3>Prelab</h3>
    <p>I spent decent time debuging the error when updating Artemis MAC address. One error is that 
    Arduino library folder actually saved both on Onedrive and locally on laptop in which case placment
    of "Sketchbook" in Onedrive potentially caused the conflicts.</p>
    <div class="code-block">
  <div class="code-header">File: <span>Serial Monitor</span></div>
  <pre><code>
    Advertising BLE with MAC: c0:81:b1:24:23:64
  </code></pre>
</div>

    <h3>Task 1</h3>
    <p>Echo is conducted in two steps: first, send one string over
         BLE to the characteristic on Artemis; second,  
         have the laptop receive the response. BLE characteristics are basically the container
         of the data which can be identified by UUID. I used case PING to construct this response.
         </p>
    <div class="code-block">
  <div class="code-header">File: <span>Demo.ipynb</span></div>
  <pre><code>
    ble.uuid
    e = ble.receive_string(ble.uuid["RX_STRING"])
    print(e)
  </code></pre>
</div>

    <div class="code-block">
  <div class="code-header">File: <span>ble_arduino.ino</span></div>
  <pre><code>
    case ECHO:

            char char_arr[MAX_MSG_SIZE];

            success = robot_cmd.get_next_value(char_arr);
            if (!success)
                return;  
            tx_estring_value.clear();
            tx_estring_value.append("Robot says -> ");
            tx_estring_value.append(char_arr);
            tx_estring_value.append(":)");
            tx_characteristic_string.writeValue(tx_estring_value.c_str());

            break;
    </code></pre>
    </div>

<img src="../images/lab1/echo.png" alt="echo result" width="550">

    <h3>Task 2</h3>
    <p>I referred to case SEND_TWO_INTS. However, the output in Arduino cut off some digits. Therefore,
        I <a href="https://arduino.stackexchange.com/questions/42965/only-2-decimal-places-in-printed-float" target="_blank">
    secured three digits as necessary </a> so that my floats can be accurate as bottom one shown. 
    </p>

        <div class="code-block">
  <div class="code-header">File: <span>ble_arduino.ino</span></div>
  <pre><code>
        case SEND_THREE_FLOATS:
            /*
             * Your code goes here.
             */
            float flt_a, flt_b, flt_c;
            success = robot_cmd.get_next_value(flt_a);
            if(!success)
                return;


            success = robot_cmd.get_next_value(flt_b);
            if(!success)
                return;


            success = robot_cmd.get_next_value(flt_c);
            if(!success)
                return;


            Serial.print("Three floats: ");
            Serial.print(flt_a);
            Serial.print(", ");
            Serial.print(flt_b);
            Serial.print(", ");
            Serial.println(flt_c);

            break;

  </code></pre>
</div>

<div class="code-block">
  <div class="code-header">File: Demo.ipynb</div>
  <pre><code>
ble.send_command(CMD.SEND_THREE_FLOATS, "123.4:3.112:-0.956")
  </code></pre>
</div>

<div class="code-block">
  <div class="code-header">Serial Monitor</div>
  <pre><code>
Advertising BLE with MAC: c0:81:b1:24:23:64
Connected to: a0:59:50:7b:9a:61
Three floats: 123.40, 3.11, -0.96
  </code></pre>
</div>

<div class="code-block">
  <div class="code-header">Serial Monitor</div>
  <pre><code>
Advertising BLE with MAC: c0:81:b1:24:23:64
Connected to: a0:59:50:7b:9a:61
Three floats: 123.400, 3.112, -0.956
  </code></pre>
</div>


    <h3>Task 3</h3>
    <p>To access time and enable robot to reply time in a string, tx_estring_value 
        and tx_characteristic_string.writevalue were used: the former is a carrier referring
        to the string, and the latter is the channel that sends the built string. Double(unsigned long)
        in C++ converts an unsigned integer value to a floating-point number, which enables
        more precise calculation.  
    </p>

    <div class="code-block">
  <div class="code-header">cmd_types.py</div>
  <pre><code>
class CMD(Enum):
    ...
    GET_TIME_MILLIS = 6 
  </code></pre>
</div> 

    <div class="code-block">
  <div class="code-header">File:ble_arduino.ino</div>
  <pre><code>
        case GET_TIME_MILLIS:

            tx_estring_value.clear();
            tx_estring_value.append("T:");
            tx_estring_value.append(millis());
            tx_characteristic_string.writeValue(tx_estring_value.c_str());

            Serial.print("Sent: ");
            Serial.println(tx_estring_value.c_str());

            break;
  </code></pre>
</div>

<img src="../images/lab1/get_time.png" alt="echo result" width="550">

    <h3>Task 4</h3>
    <p>The notification handler is very interesting: it is a callback, which means it won't work until
        BLE sends out data. Itself inside converts bytes to string to integer, while when it is called by
    start_notify it puts notification handler on hold waiting for data. I now understand why send_command
has to be behind start_notify: command cannot be sent before the notification is on, or handler won't react.  </p>

    <div class="code-block">
  <div class="code-header">Demo.ipynb</div>
  <pre><code>
def notification_handler(send, byte_array):
    time_str = ble.bytearray_to_string(byte_array)
    time_int = int(time_str.split(":")[1])
    print (time_int)

ble.start_notify(ble.uuid["RX_STRING"], notification_handler)
ble.send_command(CMD.GET_TIME_MILLIS, "")
  </code></pre>
</div> 
<p>The callback function here automatically takes output from Task 3. I do not necessarily
    need to fill in "send" / "byte_array" as python fills the augments from BLE library. 
    </p>
<div class="code-block">
  <div class="code-header">Serial Monitor</div>
  <pre><code>
Sent: T:64593.000
Sent: T:82556.000
Sent: T:115553.000
Sent: T:143196.000
  </code></pre>
</div>    

    <h3>Task 5</h3>
    <p>To estimate effective data transfer rate, I applied delay(20) to slow down the prcoess.
        I set the loop to collect until time reaches one second. I still received 85 messages as some
        of the delay may be not applied. 
    </p>

    <div class="code-block">
  <div class="code-header">cmd_types.py</div>
  <pre><code>
class CMD(Enum):
    ...
    LOOP_GETTIME = 7
  </code></pre>
</div>

    <div class="code-block">
  <div class="code-header">Serial Monitor</div>
  <pre><code>
    case LOOP_GETTIME:
               
            double t_i, t_o;
            t_i = millis();
            while (millis() - t_i < 1000)
            {
                tx_estring_value.clear();
                tx_estring_value.append("T:");
                t_o = millis();
                tx_estring_value.append(t_o);
                tx_characteristic_string.writeValue(tx_estring_value.c_str());


                delay(20);
            }
            break;
  </code></pre>
</div>

<img src="../images/lab1/loop_time.png" alt="echo result" width="550">
    <p>Since each message is 13 bytes, so by calculation the data transfer rate would 
        be 85*13/1 = 1105 bytes/s = 8840 bits/s
    </p>

    <h3>Task 6</h3>

<p>It asks the time stamps stored to an array and requires a command to loop the array 
    and send data points as string. First, I built an array that collects data with a load
     of 200. A boolean is used to prevent filling in the array when it is full. </p>

    <div class="code-block">
  <div class="code-header">Serial Monitor</div>
  <pre><code>

bool capacity_full = false;
void send_timestamp(unsigned long t){
    if (time_count < capacity_time) {
        time_box[time_count] =t;
        time_count++;
        // else it will stop collecting
    }
    if (time_count == capacity_time){
        capacity_full = true;
        Serial.println("Timestamp capacity full");
    }
}

  </code></pre>
</div>

    <p>Besides, I also wrote SEND_TIME_DATA to request a board to send collected timestamps.
         The board would go through each timestamp in time_box to send them as strings. 
        In Python, I used a notification handler to prepare to receive and process timestamps. </p>

<div class="code-block">
  <div class="code-header">File: main.ino</div>
  <pre><code>
        case SEND_TIME_DATA:
            Serial.println("Send time stamp array!");


            for (int i = 0; i < time_count; i++ ){
                tx_estring_value.clear();
                tx_estring_value.append("timestamp:");
                tx_estring_value.append((double)time_box[i]);
                tx_characteristic_string.writeValue(tx_estring_value.c_str());
                delay(20);
             
            }
            Serial.println("Finish sending array!");
            break;
    
  </code></pre>
</div>
<img src="../images/lab1/time_array.png" alt="echo result" width="550">


    <h3>Task 7</h3>






<div class="code-block">
  <div class="code-header">File: main.ino</div>
  <pre><code>...</code></pre>
</div>

<p>...</p>

    <h3>Acknowledgement</h3>
    <p>Thanks to Michelle Yang for answering my question about Task 4 streamlines of notification
        handler. 
        I referenced Trevor's and Jeffery's wesbite from last year about building
        command-handling and response construction and the formatting. I also used Generative AI
        ChatGPT for general debuging, error message analysis, and webpage writing.  
    </p>
  </div>
</body>
</html>
